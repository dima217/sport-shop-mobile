# Спецификация API для системы отзывов на товары

## Контекст

Фронтенд-приложение требует полнофункциональную систему отзывов для товаров. Пользователи должны иметь возможность оставлять отзывы с рейтингом (1-5 звезд) и комментариями, редактировать и удалять свои отзывы, а также просматривать отзывы других пользователей.

## Endpoints

### 1. Получение списка отзывов для товара

**Endpoint:** `GET /products/{productId}/reviews`

**Требуется аутентификация:** Нет (публичный доступ)

**Query параметры:**

- `limit` (number, опционально) - Количество отзывов на странице (по умолчанию: 20, максимум: 100)
- `offset` (number, опционально) - Смещение для пагинации (по умолчанию: 0)
- `sortBy` (string, опционально) - Поле для сортировки: `"createdAt"` или `"rating"` (по умолчанию: `"createdAt"`)
- `sortOrder` (string, опционально) - Порядок сортировки: `"asc"` или `"desc"` (по умолчанию: `"desc"`)
- `rating` (number, опционально) - Фильтр по рейтингу (1-5)

**Response (200 OK):**

```json
{
  "reviews": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "productId": "product-uuid",
      "userId": 1,
      "user": {
        "id": 1,
        "firstName": "Иван",
        "lastName": "Иванов",
        "avatarUrl": "https://example.com/avatar.jpg" | null
      },
      "rating": 5,
      "comment": "Отличный товар! Очень доволен покупкой.",
      "createdAt": "2024-01-15T10:30:00.000Z",
      "updatedAt": "2024-01-15T10:30:00.000Z"
    }
  ],
  "total": 42,
  "limit": 20,
  "offset": 0,
  "averageRating": 4.5,
  "ratingDistribution": {
    "5": 20,
    "4": 15,
    "3": 5,
    "2": 1,
    "1": 1
  }
}
```

**TypeScript интерфейсы:**

```typescript
interface Review {
  id: string; // UUID отзыва
  productId: string; // UUID товара
  userId: number; // ID пользователя
  user?: {
    // Опционально: информация о пользователе
    id: number;
    firstName: string;
    lastName: string;
    avatarUrl?: string | null;
  };
  rating: number; // Рейтинг 1-5
  comment: string; // Текст отзыва
  createdAt: string; // ISO 8601 дата создания
  updatedAt: string; // ISO 8601 дата обновления
}

interface ReviewsResponse {
  reviews: Review[];
  total: number; // Общее количество отзывов
  limit: number;
  offset: number;
  averageRating: number; // Средний рейтинг (0-5)
  ratingDistribution: {
    // Распределение по рейтингам
    5: number;
    4: number;
    3: number;
    2: number;
    1: number;
  };
}
```

### 2. Получение конкретного отзыва

**Endpoint:** `GET /products/{productId}/reviews/{reviewId}`

**Требуется аутентификация:** Нет (публичный доступ)

**Response (200 OK):**

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "productId": "product-uuid",
  "userId": 1,
  "user": {
    "id": 1,
    "firstName": "Иван",
    "lastName": "Иванов",
    "avatarUrl": null
  },
  "rating": 5,
  "comment": "Отличный товар!",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z"
}
```

**Response (404 Not Found):**

```json
{
  "statusCode": 404,
  "message": "Review not found"
}
```

### 3. Получение отзыва текущего пользователя для товара

**Endpoint:** `GET /products/{productId}/reviews/me`

**Требуется аутентификация:** Да (JWT Bearer token)

**Response (200 OK):** - Если отзыв существует

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "productId": "product-uuid",
  "userId": 1,
  "user": {
    "id": 1,
    "firstName": "Иван",
    "lastName": "Иванов",
    "avatarUrl": null
  },
  "rating": 5,
  "comment": "Отличный товар!",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z"
}
```

**Response (404 Not Found):** - Если отзыв не существует

```json
{
  "statusCode": 404,
  "message": "Review not found"
}
```

**Примечание:** Можно вернуть `null` вместо 404, если это удобнее для фронтенда.

### 4. Создание отзыва

**Endpoint:** `POST /products/{productId}/reviews`

**Требуется аутентификация:** Да (JWT Bearer token)

**Request Body:**

```json
{
  "rating": 5,
  "comment": "Отличный товар! Очень доволен покупкой."
}
```

**TypeScript интерфейс:**

```typescript
interface CreateReviewDto {
  rating: number; // 1-5, обязательное поле
  comment: string; // Текст отзыва, обязательное поле
}
```

**Валидация:**

- `rating` - обязательное поле, должно быть числом от 1 до 5
- `comment` - обязательное поле, не пустая строка, минимум 10 символов, максимум 2000 символов

**Response (201 Created):**

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "productId": "product-uuid",
  "userId": 1,
  "user": {
    "id": 1,
    "firstName": "Иван",
    "lastName": "Иванов",
    "avatarUrl": null
  },
  "rating": 5,
  "comment": "Отличный товар! Очень доволен покупкой.",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z"
}
```

**Ошибки:**

- **400 Bad Request** - Неверные данные (рейтинг не в диапазоне 1-5, комментарий слишком короткий/длинный)
- **401 Unauthorized** - Пользователь не аутентифицирован
- **409 Conflict** - Пользователь уже оставил отзыв на этот товар (можно разрешить только один отзыв на товар)

### 5. Обновление отзыва

**Endpoint:** `PATCH /products/{productId}/reviews/{reviewId}`

**Требуется аутентификация:** Да (JWT Bearer token)

**Права доступа:** Только автор отзыва может его редактировать

**Request Body:**

```json
{
  "rating": 4,
  "comment": "Обновленный комментарий"
}
```

**TypeScript интерфейс:**

```typescript
interface UpdateReviewDto {
  rating?: number; // 1-5, опционально
  comment?: string; // Текст отзыва, опционально
}
```

**Валидация:**

- Если `rating` указан, должно быть числом от 1 до 5
- Если `comment` указан, не пустая строка, минимум 10 символов, максимум 2000 символов
- Хотя бы одно поле (`rating` или `comment`) должно быть указано

**Response (200 OK):**

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "productId": "product-uuid",
  "userId": 1,
  "user": {
    "id": 1,
    "firstName": "Иван",
    "lastName": "Иванов",
    "avatarUrl": null
  },
  "rating": 4,
  "comment": "Обновленный комментарий",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T11:00:00.000Z"
}
```

**Ошибки:**

- **400 Bad Request** - Неверные данные
- **401 Unauthorized** - Пользователь не аутентифицирован
- **403 Forbidden** - Пользователь не является автором отзыва
- **404 Not Found** - Отзыв не найден

### 6. Удаление отзыва

**Endpoint:** `DELETE /products/{productId}/reviews/{reviewId}`

**Требуется аутентификация:** Да (JWT Bearer token)

**Права доступа:** Только автор отзыва может его удалить

**Response (200 OK):**

```json
{
  "message": "Review deleted successfully"
}
```

**Ошибки:**

- **401 Unauthorized** - Пользователь не аутентифицирован
- **403 Forbidden** - Пользователь не является автором отзыва
- **404 Not Found** - Отзыв не найден

## Требования к логике бэкенда

### 1. Обновление рейтинга товара

**ВАЖНО:** При создании, обновлении или удалении отзыва необходимо пересчитывать средний рейтинг товара (`rating`) и количество отзывов (`reviewCount`) в таблице `Product`.

**Алгоритм:**

1. При создании отзыва:

   - Увеличить `reviewCount` на 1
   - Пересчитать `rating` = среднее арифметическое всех рейтингов отзывов

2. При обновлении отзыва:

   - Пересчитать `rating` с учетом нового значения рейтинга

3. При удалении отзыва:
   - Уменьшить `reviewCount` на 1
   - Пересчитать `rating` (если `reviewCount` = 0, установить `rating` = `null`)

### 2. Ограничение на количество отзывов

- Один пользователь может оставить только **один отзыв** на один товар
- При попытке создать второй отзыв вернуть ошибку `409 Conflict`
- Пользователь может редактировать свой существующий отзыв

### 3. Валидация данных

**Рейтинг:**

- Обязательное поле при создании
- Должно быть целым числом от 1 до 5
- Опционально при обновлении (но если указано, должно быть валидным)

**Комментарий:**

- Обязательное поле при создании
- Минимум 10 символов
- Максимум 2000 символов
- Не может быть пустой строкой или только пробелами
- Опционально при обновлении (но если указано, должно быть валидным)

### 4. Права доступа

- **Создание отзыва:** Только аутентифицированные пользователи
- **Просмотр отзывов:** Публичный доступ (не требуется аутентификация)
- **Редактирование отзыва:** Только автор отзыва
- **Удаление отзыва:** Только автор отзыва

### 5. Сортировка и фильтрация

**Сортировка:**

- По дате создания (`createdAt`) - по умолчанию, новые сначала
- По рейтингу (`rating`) - от высокого к низкому или наоборот

**Фильтрация:**

- По рейтингу (1-5) - показать только отзывы с определенным рейтингом

**Пагинация:**

- Поддержка `limit` и `offset`
- По умолчанию: `limit = 20`, `offset = 0`
- Максимальный `limit = 100`

### 6. Распределение рейтингов

В ответе `GET /products/{productId}/reviews` должно быть поле `ratingDistribution`, которое показывает количество отзывов для каждого рейтинга (1-5).

## Примеры запросов

### Пример 1: Получение отзывов с пагинацией

**Request:**

```http
GET /products/123e4567-e89b-12d3-a456-426614174000/reviews?limit=10&offset=0&sortBy=createdAt&sortOrder=desc
```

**Response (200 OK):**

```json
{
  "reviews": [...],
  "total": 42,
  "limit": 10,
  "offset": 0,
  "averageRating": 4.5,
  "ratingDistribution": {
    "5": 20,
    "4": 15,
    "3": 5,
    "2": 1,
    "1": 1
  }
}
```

### Пример 2: Создание отзыва

**Request:**

```http
POST /products/123e4567-e89b-12d3-a456-426614174000/reviews
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "rating": 5,
  "comment": "Отличный товар! Качество на высоте, рекомендую."
}
```

**Response (201 Created):**

```json
{
  "id": "new-review-uuid",
  "productId": "123e4567-e89b-12d3-a456-426614174000",
  "userId": 1,
  "user": {
    "id": 1,
    "firstName": "Иван",
    "lastName": "Иванов",
    "avatarUrl": null
  },
  "rating": 5,
  "comment": "Отличный товар! Качество на высоте, рекомендую.",
  "createdAt": "2024-01-15T12:00:00.000Z",
  "updatedAt": "2024-01-15T12:00:00.000Z"
}
```

### Пример 3: Обновление отзыва

**Request:**

```http
PATCH /products/123e4567-e89b-12d3-a456-426614174000/reviews/review-uuid
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "rating": 4,
  "comment": "Хороший товар, но есть небольшие недочеты."
}
```

**Response (200 OK):**

```json
{
  "id": "review-uuid",
  "productId": "123e4567-e89b-12d3-a456-426614174000",
  "userId": 1,
  "user": {
    "id": 1,
    "firstName": "Иван",
    "lastName": "Иванов",
    "avatarUrl": null
  },
  "rating": 4,
  "comment": "Хороший товар, но есть небольшие недочеты.",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T12:30:00.000Z"
}
```

### Пример 4: Ошибка - пользователь уже оставил отзыв

**Request:**

```http
POST /products/123e4567-e89b-12d3-a456-426614174000/reviews
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "rating": 5,
  "comment": "Второй отзыв"
}
```

**Response (409 Conflict):**

```json
{
  "statusCode": 409,
  "message": "User has already reviewed this product"
}
```

## Обновление Swagger/OpenAPI документации

Необходимо добавить в Swagger документацию:

1. **Все endpoints** с полным описанием параметров, запросов и ответов
2. **Схемы данных** для `Review`, `CreateReviewDto`, `UpdateReviewDto`, `ReviewsResponse`
3. **Примеры запросов и ответов**
4. **Коды ошибок** (400, 401, 403, 404, 409)
5. **Security schemes** для защищенных endpoints

## Чеклист для проверки

- [ ] Endpoint `GET /products/{productId}/reviews` возвращает список отзывов с пагинацией
- [ ] Endpoint `GET /products/{productId}/reviews/{reviewId}` возвращает конкретный отзыв
- [ ] Endpoint `GET /products/{productId}/reviews/me` возвращает отзыв текущего пользователя
- [ ] Endpoint `POST /products/{productId}/reviews` создает новый отзыв
- [ ] Endpoint `PATCH /products/{productId}/reviews/{reviewId}` обновляет отзыв
- [ ] Endpoint `DELETE /products/{productId}/reviews/{reviewId}` удаляет отзыв
- [ ] Валидация рейтинга (1-5) работает корректно
- [ ] Валидация комментария (10-2000 символов) работает корректно
- [ ] Один пользователь может оставить только один отзыв на товар
- [ ] При создании/обновлении/удалении отзыва пересчитывается рейтинг товара
- [ ] При создании/удалении отзыва обновляется `reviewCount` товара
- [ ] Права доступа работают корректно (только автор может редактировать/удалять)
- [ ] Сортировка и фильтрация работают корректно
- [ ] Поле `ratingDistribution` рассчитывается правильно
- [ ] Swagger документация обновлена

## Дополнительные рекомендации

1. **Индексы базы данных:**

   - Индекс на `productId` для быстрого поиска отзывов товара
   - Индекс на `userId` для быстрого поиска отзывов пользователя
   - Составной индекс на `(productId, userId)` для проверки уникальности

2. **Производительность:**

   - Использовать пагинацию для больших списков отзывов
   - Кэшировать средний рейтинг товара (можно обновлять асинхронно)

3. **Безопасность:**

   - Проверять права доступа на уровне базы данных (если возможно)
   - Санитизировать пользовательский ввод (комментарии)
   - Защита от спама (можно добавить rate limiting)

4. **Дополнительные функции (опционально):**
   - Лайки/дизлайки на отзывы
   - Ответы на отзывы (комментарии к отзывам)
   - Модерация отзывов (для администраторов)
   - Отчеты о неподходящих отзывах
