# Обновление API для создания заказа

## Контекст

Фронтенд-приложение готово к интеграции с бэкендом для создания заказов. Текущая реализация на фронтенде отправляет данные в определенном формате, и бэкенд должен быть обновлен для соответствия этим требованиям.

## Текущая реализация на фронтенде

### Endpoint: `POST /orders`

**Требуется аутентификация:** Да (JWT Bearer token в заголовке `Authorization`)

### Тело запроса (Request Body)

Фронтенд отправляет следующий JSON:

```json
{
  "deliveryAddress": {
    "street": "ул. Ленина, д. 10, кв. 25",
    "city": "Москва",
    "postalCode": "123456",
    "country": "Россия"
  },
  "paymentMethod": "card" | "cash",
  "comment": "Дополнительные пожелания к заказу" | null
}
```

### Структура данных (TypeScript интерфейсы)

```typescript
interface DeliveryAddressDto {
  street: string; // Обязательное поле
  city: string; // Обязательное поле
  postalCode: string; // Обязательное поле
  country: string; // Обязательное поле
}

interface CreateOrderDto {
  deliveryAddress: DeliveryAddressDto; // Обязательное поле
  paymentMethod: "card" | "cash"; // Обязательное поле, только эти два значения
  comment?: string | null; // Опциональное поле
}
```

### Ожидаемый ответ (Response)

**Успешный ответ (200 OK):**

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "userId": 1,
  "status": "pending",
  "deliveryStreet": "ул. Ленина, д. 10, кв. 25",
  "deliveryCity": "Москва",
  "deliveryPostalCode": "123456",
  "deliveryCountry": "Россия",
  "paymentMethod": "card",
  "comment": "Дополнительные пожелания к заказу" | null,
  "total": 8990,
  "createdAt": "2024-01-15T10:30:00Z",
  "items": [
    {
      "id": "item-uuid",
      "productId": "product-uuid",
      "quantity": 2,
      "size": "M",
      "color": "Черный",
      "price": 2990
    }
  ]
}
```

**TypeScript интерфейс ответа:**

```typescript
interface Order {
  id: string; // UUID заказа
  userId: number; // ID пользователя
  status: "pending" | "processing" | "shipped" | "delivered" | "cancelled";
  deliveryStreet: string; // Улица из deliveryAddress.street
  deliveryCity: string; // Город из deliveryAddress.city
  deliveryPostalCode: string; // Индекс из deliveryAddress.postalCode
  deliveryCountry: string; // Страна из deliveryAddress.country
  paymentMethod: "card" | "cash";
  comment?: string | null;
  total: number; // Общая сумма заказа в рублях
  createdAt: string; // ISO 8601 дата/время
  items?: CartItem[]; // Опционально: массив товаров заказа
}
```

## Требования к логике бэкенда

### 1. Создание заказа из корзины

**ВАЖНО:** Заказ должен создаваться на основе текущей корзины пользователя.

- Бэкенд должен автоматически получить все товары из корзины текущего пользователя (по JWT токену)
- Если корзина пуста, вернуть ошибку `400 Bad Request` с сообщением "Cart is empty"
- Рассчитать общую сумму заказа на основе товаров в корзине и их количества

### 2. Валидация данных

**Обязательные поля:**

- `deliveryAddress.street` - не пустая строка
- `deliveryAddress.city` - не пустая строка
- `deliveryAddress.postalCode` - не пустая строка
- `deliveryAddress.country` - не пустая строка
- `paymentMethod` - только "card" или "cash"

**Опциональные поля:**

- `comment` - может быть `null` или строкой

**Ошибки валидации:**

- При отсутствии обязательных полей вернуть `400 Bad Request` с массивом ошибок валидации
- При неверном значении `paymentMethod` вернуть `400 Bad Request`

### 3. Обработка после создания заказа

После успешного создания заказа:

- Товары из корзины должны быть перенесены в заказ
- Корзина пользователя должна быть очищена (или это может быть отдельный endpoint, который фронтенд вызовет сам)

**Примечание:** Фронтенд после получения успешного ответа вызывает `DELETE /cart` для очистки корзины, но бэкенд может очистить корзину автоматически при создании заказа.

### 4. Обработка ошибок

**Возможные ошибки:**

1. **401 Unauthorized** - пользователь не аутентифицирован

   ```json
   {
     "statusCode": 401,
     "message": "Unauthorized"
   }
   ```

2. **400 Bad Request** - корзина пуста или ошибка валидации

   ```json
   {
     "statusCode": 400,
     "message": "Cart is empty" | ["field is required", ...]
   }
   ```

3. **500 Internal Server Error** - внутренняя ошибка сервера

## Примеры запросов

### Пример 1: Создание заказа с оплатой картой

**Request:**

```http
POST /orders
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "deliveryAddress": {
    "street": "ул. Ленина, д. 10, кв. 25",
    "city": "Москва",
    "postalCode": "123456",
    "country": "Россия"
  },
  "paymentMethod": "card",
  "comment": "Позвоните за час до доставки"
}
```

**Response (200 OK):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "userId": 1,
  "status": "pending",
  "deliveryStreet": "ул. Ленина, д. 10, кв. 25",
  "deliveryCity": "Москва",
  "deliveryPostalCode": "123456",
  "deliveryCountry": "Россия",
  "paymentMethod": "card",
  "comment": "Позвоните за час до доставки",
  "total": 12980,
  "createdAt": "2024-01-15T10:30:00.000Z"
}
```

### Пример 2: Создание заказа с оплатой наличными без комментария

**Request:**

```http
POST /orders
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "deliveryAddress": {
    "street": "пр. Победы, д. 5",
    "city": "Санкт-Петербург",
    "postalCode": "190000",
    "country": "Россия"
  },
  "paymentMethod": "cash",
  "comment": null
}
```

**Response (200 OK):**

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "userId": 1,
  "status": "pending",
  "deliveryStreet": "пр. Победы, д. 5",
  "deliveryCity": "Санкт-Петербург",
  "deliveryPostalCode": "190000",
  "deliveryCountry": "Россия",
  "paymentMethod": "cash",
  "comment": null,
  "total": 5990,
  "createdAt": "2024-01-15T11:00:00.000Z"
}
```

### Пример 3: Ошибка - пустая корзина

**Request:**

```http
POST /orders
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "deliveryAddress": {
    "street": "ул. Тестовая, д. 1",
    "city": "Москва",
    "postalCode": "123456",
    "country": "Россия"
  },
  "paymentMethod": "card"
}
```

**Response (400 Bad Request):**

```json
{
  "statusCode": 400,
  "message": "Cart is empty"
}
```

## Обновление Swagger/OpenAPI документации

Необходимо обновить Swagger документацию для endpoint `POST /orders`:

1. **Request Body Schema:**

   - Добавить схему `CreateOrderDto` с вложенной схемой `DeliveryAddressDto`
   - Указать обязательные и опциональные поля
   - Добавить enum для `paymentMethod` с значениями `["card", "cash"]`

2. **Response Schema:**

   - Обновить схему `Order` чтобы она соответствовала описанной выше структуре
   - Убедиться, что все поля присутствуют и имеют правильные типы

3. **Error Responses:**
   - Добавить примеры ошибок 400, 401, 500

## Статусы заказов

### Система статусов

Заказ должен иметь поле `status` с одним из следующих значений:

1. **`"pending"`** - Заказ создан, ожидает подтверждения/обработки

   - Это начальный статус при создании заказа
   - Фронтенд отображает: "Ожидает" (серый цвет)
   - Заказ только что создан, но еще не принят в обработку

2. **`"processing"`** - Заказ принят, обрабатывается

   - Заказ принят администратором/системой
   - Фронтенд отображает: "Обрабатывается" (основной цвет приложения)
   - Заказ готовится к отправке

3. **`"shipped"`** - Заказ отправлен

   - Заказ передан в службу доставки
   - Фронтенд отображает: "Отправлен" (темный основной цвет)
   - Заказ в пути к клиенту

4. **`"delivered"`** - Заказ доставлен

   - Заказ успешно доставлен клиенту
   - Фронтенд отображает: "Доставлен" (зеленый цвет #4CAF50)
   - Финальный успешный статус

5. **`"cancelled"`** - Заказ отменен
   - Заказ был отменен (клиентом или администратором)
   - Фронтенд отображает: "Отменен" (красный цвет)
   - Финальный статус отмены

### Правила изменения статусов

1. **При создании:** Заказ всегда создается со статусом `"pending"`

2. **Переходы статусов:**

   - `pending` → `processing` (принятие заказа)
   - `pending` → `cancelled` (отмена до обработки)
   - `processing` → `shipped` (отправка заказа)
   - `processing` → `cancelled` (отмена во время обработки)
   - `shipped` → `delivered` (доставка завершена)
   - `shipped` → `cancelled` (отмена во время доставки - редко)

3. **Обратное движение:** Статусы не должны возвращаться назад (например, из `shipped` в `processing`)

4. **Финальные статусы:** `delivered` и `cancelled` - финальные, дальнейшие изменения не ожидаются

### API для изменения статуса (опционально)

Если планируется изменение статусов через API, рекомендуется добавить endpoint:

```
PATCH /orders/{id}/status
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "status": "processing" | "shipped" | "delivered" | "cancelled"
}
```

**Валидация:**

- Проверка допустимых переходов статусов
- Только администраторы могут изменять статусы
- Нельзя изменить статус `delivered` или `cancelled` на другой

## Важные замечания

1. **Порядок полей в ответе:** Поля `deliveryStreet`, `deliveryCity`, `deliveryPostalCode`, `deliveryCountry` должны быть на верхнем уровне объекта `Order`, а не вложены в `deliveryAddress`.

2. **Формат даты:** Поле `createdAt` должно быть в формате ISO 8601 (например: `"2024-01-15T10:30:00.000Z"`).

3. **Расчет суммы:** Поле `total` должно быть рассчитано на основе товаров в корзине (цена товара × количество для каждого товара).

4. **Статус заказа:** При создании заказ всегда должен иметь статус `"pending"`. Это означает, что заказ создан, но еще не принят в обработку. Администратор или система должны вручную или автоматически изменить статус на `"processing"` когда заказ будет принят.

5. **Идентификатор пользователя:** `userId` берется из JWT токена, не передается в теле запроса.

6. **Отображение статусов:** Фронтенд использует статусы для визуального отображения состояния заказа. Каждый статус имеет свой цвет и текст, который отображается пользователю.

## Чеклист для проверки

- [ ] Endpoint `POST /orders` принимает данные в формате `CreateOrderDto`
- [ ] Валидация всех обязательных полей работает корректно
- [ ] Заказ создается из товаров корзины текущего пользователя
- [ ] При пустой корзине возвращается ошибка 400
- [ ] Ответ содержит все необходимые поля в правильном формате
- [ ] Поля адреса доставки находятся на верхнем уровне объекта `Order`
- [ ] **Статус заказа:** При создании заказ всегда имеет статус `"pending"`
- [ ] **Статусы:** Поддерживаются все 5 статусов (`pending`, `processing`, `shipped`, `delivered`, `cancelled`)
- [ ] **Валидация статусов:** Поле `status` может содержать только допустимые значения
- [ ] Swagger документация обновлена (включая описание статусов)
- [ ] Обработка ошибок реализована корректно
